<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usuários do Sistema - RDAT</title>
    <link rel="shortcut icon" href="/static/imagens/modelo-oficial-icon-accerth-removebg-preview (4).png">
    <link rel="stylesheet" href="{{ url_for('static', filename='system_users.css') }}?v=2.2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <img src="/static/imagens/logo-accerth-oficial.png" alt="Accerth Logo" class="logo">
            <button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Alternar menu lateral">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        <div class="sidebar-content">
            <nav>
                <ul>
                    <li><a href="{{ url_for('home') }}" class="{% if request.endpoint == 'home' %}active{% endif %}" aria-label="Tela Inicial"><i class="fas fa-home"></i> Tela Inicial</a></li>
                    <li class="collapsible submenu-active">
                        <a href="#" onclick="toggleSubmenu(this); return false;" aria-label="Expandir menu de cadastros gerais"><i class="fas fa-users"></i> Cadastros Gerais <i class="fas fa-chevron-right arrow"></i></a>
                        <ul class="submenu">
                            <li><a href="{{ url_for('add_unit') }}" class="{% if request.endpoint == 'add_unit' %}active{% endif %}" aria-label="Cadastrar Unidade"><i class="fas fa-building"></i> Cadastrar Unidade</a></li>
                            <li><a href="{{ url_for('add_employee') }}" class="{% if request.endpoint == 'add_employee' %}active{% endif %}" aria-label="Cadastrar Funcionário"><i class="fas fa-user-plus"></i> Cadastrar Funcionário</a></li>
                            <li><a href="{{ url_for('employees') }}" class="{% if request.endpoint == 'employees' %}active{% endif %}" aria-label="Funcionários"><i class="fas fa-users"></i> Funcionários</a></li>
                            <li><a href="{{ url_for('system_users') }}" class="{% if request.endpoint == 'system_users' %}active{% endif %}" aria-label="Usuários do Sistema"><i class="fas fa-user-shield"></i> Usuários do Sistema</a></li>
                        </ul>
                    </li>
                    <li class="collapsible">
                        <a href="#" onclick="toggleSubmenu(this); return false;" aria-label="Expandir menu de relatórios"><i class="fas fa-file-alt"></i> Relatórios <i class="fas fa-chevron-right arrow"></i></a>
                        <ul class="submenu">
                            <li><a href="{{ url_for('employer_reports') }}" class="{% if request.endpoint == 'employer_reports' %}active{% endif %}" aria-label="Acompanhar Relatórios"><i class="fas fa-eye"></i> Acompanhar Relatórios</a></li>
                            <li><a href="{{ url_for('signed_reports_empregador') }}" class="{% if request.endpoint == 'signed_reports_empregador' %}active{% endif %}" aria-label="Gerar Relatórios Assinados"><i class="fas fa-file-signature"></i> Gerar Relatórios Assinados</a></li>
                            {% if session['role'] in ['colaborador', 'empregador'] %}
                            <li><a href="{{ url_for('units') }}" class="{% if request.endpoint == 'units' %}active{% endif %}" aria-label="Enviar Relatórios"><i class="fas fa-file-arrow-up"></i> Enviar Relatórios</a></li>
                            {% endif %}
                        </ul>
                    </li>
                </ul>
            </nav>
        </div>
        <div class="sidebar-footer">
            <ul>
                <li><a href="{{ url_for('duvidas') }}" class="footer-link {% if request.endpoint == 'duvidas' %}active{% endif %}" aria-label="Dúvidas"><i class="fas fa-question-circle"></i> Dúvidas</a></li>
            </ul>
        </div>
    </aside>
    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header>
            <div class="header-content">
                <span>Bem-vindo, {{ employee_name }}!</span>
                <div class="header-right">
                    <a href="{{ url_for('logout') }}" aria-label="Sair do sistema">Sair</a>
                </div>
            </div>
        </header>
        <!-- Section -->
        <section class="section">
            <h2>Usuários do Sistema</h2>
            <!-- Add/Edit User Form -->
            <div class="form-container">
                <h3 id="form-title">Adicionar Usuário</h3>
                <form id="user-form" method="POST" action="{{ url_for('add_system_user') }}" class="unit-form">
                    <input type="hidden" id="user_id" name="user_id">
                    <div class="form-group">
                        <label for="name">Nome</label>
                        <input type="text" id="name" name="name" placeholder="Digite o nome" required aria-required="true" aria-label="Nome do usuário">
                    </div>
                    <div class="form-group">
                        <label for="email">E-mail</label>
                        <input type="email" id="email" name="email" placeholder="Digite o e-mail" required aria-required="true" aria-label="E-mail do usuário">
                    </div>
                    <div class="form-group">
                        <label for="pin">Senha</label>
                        <input type="password" id="pin" name="pin" placeholder="Deixe em branco para manter a senha atual" aria-label="Senha do usuário">
                    </div>
                    <div class="form-group">
                        <label for="role">Papel</label>
                        <select id="role" name="role" onchange="toggleUnitField()" required aria-required="true" aria-label="Papel do usuário">
                            <option value="empregador">Empregador</option>
                            <option value="fiscal">Fiscal</option>
                            <option value="preposto">Preposto</option>
                        </select>
                    </div>
                    <div class="form-group hidden" id="unit-field">
                        <label for="unit">Unidade</label>
                        <select id="unit" name="unit" aria-label="Unidade do usuário">
                            <option value="">Selecione uma unidade</option>
                            {% for unit in units %}
                                <option value="{{ unit.name }}">{{ unit.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-buttons">
                        <button type="submit" class="btn primary" aria-label="Salvar usuário"><i class="fas fa-save"></i> Salvar</button>
                        <a href="{{ url_for('system_users') }}" class="btn secondary hidden" id="cancel-edit" aria-label="Cancelar edição">Cancelar</a>
                    </div>
                </form>
            </div>
            <!-- Employers Table -->
            <div class="table-container employers-table">
                <h3>Empregadores</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>E-mail</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for employer in employers %}
                            <tr>
                                <td>{{ employer.name }}</td>
                                <td>{{ employer.email }}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn edit-btn" onclick="editUser({{ employer.id }}, '{{ employer.name }}', '{{ employer.email }}', 'empregador', '')" aria-label="Editar empregador {{ employer.name }}"><i class="fas fa-edit"></i> Editar</button>
                                        <button class="btn delete-btn" onclick="deleteUser({{ employer.id }}, 'empregador')" aria-label="Excluir empregador {{ employer.name }}"><i class="fas fa-trash"></i> Excluir</button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <!-- Fiscals Table -->
            <div class="table-container fiscals-table">
                <h3>Fiscais</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>E-mail</th>
                            <th>Unidade</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for fiscal in fiscals %}
                            <tr>
                                <td>{{ fiscal.name }}</td>
                                <td>{{ fiscal.email }}</td>
                                <td>{{ fiscal.unit or 'N/A' }}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn edit-btn" onclick="editUser({{ fiscal.id }}, '{{ fiscal.name }}', '{{ fiscal.email }}', 'fiscal', '{{ fiscal.unit or '' }}')" aria-label="Editar fiscal {{ fiscal.name }}"><i class="fas fa-edit"></i> Editar</button>
                                        <button class="btn delete-btn" onclick="deleteUser({{ fiscal.id }}, 'fiscal')" aria-label="Excluir fiscal {{ fiscal.name }}"><i class="fas fa-trash"></i> Excluir</button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <!-- Prepostos Table -->
            <div class="table-container prepostos-table">
                <h3>Prepostos</h3>
                <!-- Debug: Exibir dados de prepostos -->
                <div style="display: none;">
                    {% if prepostos %}
                        <p>Prepostos encontrados: {{ prepostos | length }}</p>
                        {% for preposto in prepostos %}
                            <p>ID: {{ preposto.id }}, Nome: {{ preposto.name }}, E-mail: {{ preposto.email }}, Unidade: {{ preposto.unit or 'N/A' }}</p>
                        {% endfor %}
                    {% else %}
                        <p>Nenhum preposto encontrado.</p>
                    {% endif %}
                </div>
                <!-- Mensagem caso a tabela esteja vazia -->
                {% if not prepostos %}
                    <p style="text-align: center; color: #374151; margin: 1rem 0;">Nenhum preposto cadastrado.</p>
                {% endif %}
                <table>
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>E-mail</th>
                            <th>Unidade</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="prepostos-table-body">
                        {% for preposto in prepostos %}
                            <tr data-user-id="{{ preposto.id }}">
                                <td>{{ preposto.name }}</td>
                                <td>{{ preposto.email }}</td>
                                <td>{{ preposto.unit or 'N/A' }}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn edit-btn" onclick="editUser({{ preposto.id }}, '{{ preposto.name }}', '{{ preposto.email }}', 'preposto', '{{ preposto.unit or '' }}')" aria-label="Editar preposto {{ preposto.name }}"><i class="fas fa-edit"></i> Editar</button>
                                        <button class="btn delete-btn" onclick="deleteUser({{ preposto.id }}, 'preposto')" aria-label="Excluir preposto {{ preposto.name }}"><i class="fas fa-trash"></i> Excluir</button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
    </div>
    <!-- Notificações -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="notification {{ 'error' if category == 'error' else 'success' }}" data-notification>
                    <div class="notification-content">
                        <span>{{ message }}</span>
                        <button class="notification-close" onclick="this.parentElement.parentElement.remove()" aria-label="Fechar notificação">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="progress-bar"></div>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    <script>
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('active');
            console.log('Sidebar toggled');
        }

        function toggleSubmenu(element) {
            const submenu = element.nextElementSibling;
            const arrow = element.querySelector('.arrow');
            element.parentElement.classList.toggle('submenu-active');
            submenu.style.maxHeight = submenu.style.maxHeight ? null : submenu.scrollHeight + 20 + 'px';
            arrow.style.transform = submenu.style.maxHeight ? 'rotate(90deg)' : 'rotate(0deg)';
            console.log('Submenu toggled:', element.textContent);
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded');
            document.querySelectorAll('.collapsible.submenu-active').forEach(collapsible => {
                const submenu = collapsible.querySelector('.submenu');
                const arrow = collapsible.querySelector('.arrow');
                submenu.style.maxHeight = submenu.scrollHeight + 20 + 'px';
                arrow.style.transform = 'rotate(90deg)';
                console.log('Submenu initialized:', collapsible.textContent);
            });

            // Configurar envio do formulário via AJAX
            document.getElementById('user-form').addEventListener('submit', async (event) => {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                const userId = document.getElementById('user_id').value;
                const actionUrl = userId ? '{{ url_for("edit_system_user") }}' : '{{ url_for("add_system_user") }}';

                try {
                    const response = await fetch(actionUrl, {
                        method: 'POST',
                        body: formData
                    });

                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        const responseText = await response.text();
                        throw new Error(`Resposta do servidor não é JSON (status ${response.status}): ${responseText.slice(0, 100)}`);
                    }

                    const data = await response.json();
                    console.log('Resposta do servidor:', data);

                    if (data.status === 'success') {
                        showNotification(data.message, 'success');
                        if (!userId && data.user && data.user.role === 'preposto') {
                            if (data.user.id && data.user.name && data.user.email) {
                                addPrepostoToTable(data.user);
                                resetForm();
                                const noPrepostosMsg = document.querySelector('.prepostos-table p');
                                if (noPrepostosMsg) noPrepostosMsg.remove();
                            } else {
                                console.error('Dados do usuário incompletos:', data.user);
                                showNotification('Cadastro realizado, mas não foi possível atualizar a tabela. Recarregando...', 'success');
                                setTimeout(() => window.location.reload(), 2000);
                            }
                        } else if (userId && data.user && data.user.role === 'preposto') {
                            if (data.user.id && data.user.name && data.user.email) {
                                updateTableRow(data.user);
                                resetForm();
                            } else {
                                console.error('Dados do usuário incompletos para edição:', data.user);
                                showNotification('Edição realizada, mas não foi possível atualizar a tabela. Recarregando...', 'success');
                                setTimeout(() => window.location.reload(), 2000);
                            }
                        } else {
                            showNotification('Cadastro realizado. Recarregando...', 'success');
                            setTimeout(() => window.location.reload(), 1000);
                        }
                    } else {
                        showNotification(data.message, 'error');
                    }
                } catch (error) {
                    console.error('Erro ao processar o formulário:', error);
                    showNotification('Erro ao processar o formulário: ' + error.message, 'error');
                }
            });

            document.querySelectorAll('[data-notification]').forEach(notification => {
                console.log('Notificação estática:', {
                    message: notification.querySelector('span').textContent,
                    className: notification.className
                });
                setTimeout(() => notification.remove(), 5000);
            });
        });

        function showNotification(message, type) {
            console.log('Showing notification:', message, type);
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.setAttribute('data-notification', '');
            notification.innerHTML = `
                <div class="notification-content">
                    <span>${message}</span>
                    <button class="notification-close" onclick="this.parentElement.parentElement.remove()" aria-label="Fechar notificação">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="progress-bar"></div>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }

        function toggleUnitField() {
            const role = document.getElementById('role').value;
            const unitField = document.getElementById('unit-field');
            unitField.classList.toggle('hidden', !(role === 'fiscal' || role === 'preposto'));
            const unitSelect = document.getElementById('unit');
            if (role === 'fiscal' || role === 'preposto') {
                unitSelect.setAttribute('required', 'required');
            } else {
                unitSelect.removeAttribute('required');
            }
        }

        function addPrepostoToTable(user) {
            const tbody = document.getElementById('prepostos-table-body');
            if (!tbody) {
                console.error('Elemento prepostos-table-body não encontrado');
                return;
            }
            const tr = document.createElement('tr');
            tr.setAttribute('data-user-id', user.id);
            tr.innerHTML = `
                <td>${user.name}</td>
                <td>${user.email}</td>
                <td>${user.unit || 'N/A'}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn edit-btn" onclick="editUser(${user.id}, '${user.name}', '${user.email}', 'preposto', '${user.unit || ''}')" aria-label="Editar preposto ${user.name}"><i class="fas fa-edit"></i> Editar</button>
                        <button class="btn delete-btn" onclick="deleteUser(${user.id}, 'preposto')" aria-label="Excluir preposto ${user.name}"><i class="fas fa-trash"></i> Excluir</button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
            console.log('Preposto adicionado à tabela:', user);
        }

        function updateTableRow(user) {
            const tbody = document.getElementById('prepostos-table-body');
            if (!tbody) {
                console.error('Elemento prepostos-table-body não encontrado');
                return;
            }
            const row = tbody.querySelector(`tr[data-user-id="${user.id}"]`);
            if (row && user.role === 'preposto') {
                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.unit || 'N/A'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn edit-btn" onclick="editUser(${user.id}, '${user.name}', '${user.email}', 'preposto', '${user.unit || ''}')" aria-label="Editar preposto ${user.name}"><i class="fas fa-edit"></i> Editar</button>
                            <button class="btn delete-btn" onclick="deleteUser(${user.id}, 'preposto')" aria-label="Excluir preposto ${user.name}"><i class="fas fa-trash"></i> Excluir</button>
                        </div>
                    </td>
                `;
                console.log('Linha do preposto atualizada:', user);
            } else {
                console.error('Linha não encontrada ou papel inválido:', user);
            }
        }

        function editUser(id, name, email, role, unit) {
            document.getElementById('form-title').textContent = 'Editar Usuário';
            document.getElementById('user_id').value = id;
            document.getElementById('name').value = name;
            document.getElementById('email').value = email;
            document.getElementById('pin').value = '';
            document.getElementById('role').value = role;
            document.getElementById('unit').value = unit || '';
            document.getElementById('user-form').action = "{{ url_for('edit_system_user') }}";
            document.getElementById('cancel-edit').classList.remove('hidden');
            toggleUnitField();
            console.log('Editando usuário:', { id, name, email, role, unit });
            document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        async function deleteUser(id, role) {
            if (confirm(`Tem certeza que deseja excluir este ${role}?`)) {
                try {
                    const response = await fetch('{{ url_for('delete_system_user') }}', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: id, role: role })
                    });

                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        const responseText = await response.text();
                        throw new Error(`Resposta do servidor não é JSON (status ${response.status}): ${responseText.slice(0, 100)}`);
                    }

                    const data = await response.json();
                    console.log('Resposta da exclusão:', data);
                    if (data.status === 'success') {
                        showNotification(data.message, 'success');
                        const row = document.querySelector(`tr td button[onclick*='deleteUser(${id},']`).closest('tr');
                        if (row) {
                            row.remove();
                            console.log(`Usuário ${role} com ID ${id} removido da tabela`);
                            if (role === 'preposto' && !document.querySelector('#prepostos-table-body tr')) {
                                const tableContainer = document.querySelector('.prepostos-table');
                                const noPrepostosMsg = document.createElement('p');
                                noPrepostosMsg.style.textAlign = 'center';
                                noPrepostosMsg.style.color = '#374151';
                                noPrepostosMsg.style.margin = '1rem 0';
                                noPrepostosMsg.textContent = 'Nenhum preposto cadastrado.';
                                tableContainer.insertBefore(noPrepostosMsg, tableContainer.querySelector('table'));
                            }
                        }
                    } else {
                        showNotification(data.message, 'error');
                    }
                } catch (error) {
                    console.error('Erro ao excluir usuário:', error);
                    showNotification('Erro ao excluir usuário: ' + error.message, 'error');
                }
            }
        }

        document.querySelectorAll('.progress-bar').forEach(bar => {
            bar.addEventListener('animationend', () => {
                bar.closest('.notification').remove();
            });
        });
    </script>
</body>
</html>